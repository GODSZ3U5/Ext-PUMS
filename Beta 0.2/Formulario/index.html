<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Mantenimiento</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  
    <style>
        .titulo {
    font-size: 25px; 
    color: red;
    font-family: arial;  
    margin-top: 50px;         
}
.container {
    margin-bottom: 4.5cm;
    margin-top: 4.5cm;
    margin-left: 4.5cm;
    margin-right: 4.5cm;
    padding: 0px;
    width: auto;
    max-width: 2700px;
}
.form-container {
    padding: 20px;
    border-radius: 15px;
    border: 2px solid rgba(201, 0, 0, 0.564);
    box-shadow: 0 6px 10px rgba(0.1, 0.2, 0.3, 0.4);
    width: 100%;
    max-width: 100%;
}
.form-group {
    margin-bottom: 1.5rem;
}
.btn-red {
    background-color: rgb(196, 0, 0);
    color: white;
    font-size: 18px;
    width: auto;
    margin-top: 20px;
    border-radius: 7px;
}
.left-column, .right-column {
    padding: 10px;
}
.left-column {
    flex: 1;
    padding-right: 20px;
}
.right-column {
    flex: 1;
    padding-left: 20px;
}
.tooltip-icon {
    margin-left: 5px;
    cursor: pointer;
    color: #007bff;
}
.calendario {
    max-height: 400px;
    width: 100%;
    padding: 0px;
    max-width: 350px;
    margin: 0 auto;
    font-family: Arial, sans-serif;
}
.calendario th {
    margin-top: 0px;
    background-color: #ff0000d1;
    color: white;
    height: 16px;
}
/* Reducir altura de las celdas */
.fc {
    border: 0px solid #ddd; /* Borde alrededor del calendario */
    border-radius: 5px; /* Bordes redondeados */
    background-color: white; /* Fondo blanco uniforme */
}

.fc-header-toolbar {
    margin-bottom: -1px; /* Une la toolbar y la cuadrícula de días */
    padding: 0; /* Elimina padding interno */
    background-color: #ff0000; /* Fondo rojo */
    color: white; /* Texto blanco */
}

.fc-toolbar {
    background-color: #ff0000; /* Fondo rojo */
    color: white;
    text-align: center;
}

.fc-toolbar-title {
    font-size: 16px;
    font-weight: bold;
}

.fc-button {
    background-color: transparent;
    border: none;
    color: white;
    font-size: 14px;
    cursor: pointer;
}

.fc-daygrid {
    margin-top: 0; /* Elimina espacio extra entre toolbar y cuadrícula */
}

.fc-daygrid-day-top {
    font-size: 20px; /* Reducir tamaño de los números de los días */
    height: 0px;
}

.fc-daygrid-day {
    padding: 0; /* Quita padding interno de las celdas */
}

.fc-scroller-harness {
    overflow: visible; /* Permite que el contenido fluya sin restricciones */
}
</style>
</head>
<body>
<div class="container">
    <div class="form-container">
        <h2 class="titulo">Nuevo caso programado</h2>
        <form id="mantenimientoForm">
            <div class="form-row">
                <!-- Columna izquierda -->
                <div class="left-column">
                    <div class="form-group">
                        <label for="usuario">Usuario</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Su usuario en centauro">&#x3f;</span>
                        <input type="text" class="form-control" id="usuario" placeholder="" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Su nombre de usuario">&#x3f;</span>
                        <input type="text" class="form-control" id="nombre" placeholder="" required>
                    </div>

                    <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese el cargo del usuario del mantenimiento">&#x3f;</span>
                        <input type="text" class="form-control" id="cargo" placeholder="" required>
                    </div>

                    <div class="form-group">
                        <label for="usuario_da">Usuario DA</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese el usuario DA del usuario del mantenimiento">&#x3f;</span>
                        <input type="text" class="form-control" id="usuario_da" placeholder="" required>
                    </div>

                    <div class="form-group">
                        <label for="activo_fijo">Activo Fijo del Equipo</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese el número de activo fijo del equipo al cual se le va realizar el proceso (en caso de ser un cambio, por favor ingrese el del equipo que va a quedar activo)">&#x3f;</span>
                        <input type="text" class="form-control" id="activo_fijo" placeholder="" required>
                    </div>

                    <div class="form-group">
                        <label for="contrasena">Contraseña de Acceso al Equipo</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese la contraseña de acceso al equipo, correo, etc">&#x3f;</span>
                        <input type="password" class="form-control" id="contrasena" placeholder="" required>
                    </div>

                    <div class="form-group">
                        <label for="contacto">Número de Contacto</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese el o los números de contacto separados con '-'">&#x3f;</span>
                        <input type="text" class="form-control" id="contacto" placeholder="" required>
                    </div>
                </div>

                <!-- Columna derecha -->
                <div class="right-column">
                    <div class="form-group">
                        <label for="tarea">Tarea a Realizar</label>
                        <select class="form-control" id="tarea" required>
                            <option value="">Seleccione...</option>
                            <option value="revision">Revisión por daño</option>
                            <option value="cambio">Cambio de equipo</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="especificacion">Especificación del Caso</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese una descripción de por qué está solicitando un mantenimiento">&#x3f;</span>
                        <textarea class="form-control" id="especificacion" rows="3" placeholder="" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="observaciones">Observaciones</label>
                        <span class="tooltip-icon" data-toggle="tooltip" title="Ingrese datos adicionales sobre el mantenimiento no antes especificados">&#x3f;</span>
                        <textarea class="form-control" id="observaciones" rows="3" placeholder=""></textarea>
                    </div>

                    <div class="form-group">
                        <label for="fecha_mantenimiento">Fecha del Mantenimiento</label>
                        <input type="text" class="form-control" id="fecha_mantenimiento" placeholder="Seleccione la fecha" readonly>
                        <div class="calendario" id="calendar"></div>
                    </div>

                    <!-- Botón alineado a la derecha -->
                    <div class="text-right">
                        <button type="submit" class="btn btn-red btn-sm">Crea tu caso</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
   $(document).ready(function () {
    const getValidRange = () => {
        const startDate = new Date();
        startDate.setDate(1); // Primer día del mes actual
        const endDate = new Date(startDate);
        endDate.setMonth(startDate.getMonth() + 3); // Limitar a tres meses desde el mes actual
        endDate.setDate(0); // Último día del segundo mes
        return { start: startDate, end: endDate };
    };

    var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',  // Vista inicial
        headerToolbar: {
            left: 'prev,next',
            center: 'title',
            right: ''
        },
        validRange: getValidRange(), // Limitar a los dos próximos meses
        height: 'auto', // Ajusta la altura automáticamente para que la barra quede unida al calendario
        contentHeight: 'auto' // Ajusta el contenido para unir la barra y el calendario
    });

    // Evento para cuando se hace clic en una fecha
    calendar.on('dateClick', function(info) {
        const fechaSeleccionada = info.date;  // Objeto Date
        const fechaFormateada = fechaSeleccionada.toISOString().split('T')[0];  // Formato YYYY-MM-DD
        
        $('#fecha_mantenimiento').val(fechaFormateada);

        // Verificar disponibilidad de la fecha
        fetch('http://localhost:8080/Proyectos/Ext%20PUMS/Beta%200.2/Calendario/turnos.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `fecha=${fechaFormateada}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("El día seleccionado no está disponible.");
                $('#mantenimientoForm').find(':submit').prop('disabled', true);  // Desactivar el botón de envío
            } else {
                alert("Seleccionaste el día: " + fechaFormateada);
                $('#mantenimientoForm').find(':submit').prop('disabled', false);  // Habilitar el botón de envío
                console.log('Respuesta de la API:', data);
            }
        })
        .catch(error => {
            console.error('Error en la solicitud:', error);
        });
    });

    // Renderiza el calendario
    calendar.render();
});

$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});

$('#mantenimientoForm').on('submit', function(event) {
    event.preventDefault();
    const usuario = $('#usuario').val();
    const nombre = $('#nombre').val();
    const cargo = $('#cargo').val();
    const usuarioDa = $('#usuario_da').val();
    const activoFijo = $('#activo_fijo').val();
    const contrasena = $('#contrasena').val();
    const contacto = $('#contacto').val();
    const tarea = $('#tarea').val();
    const especificacion = $('#especificacion').val();
    const observaciones = $('#observaciones').val();
    const fecha = $('#fecha_mantenimiento').val();

    // Concatenar la descripción
    const descripcion = `${usuarioDa} ${especificacion} "EXT" ${contacto} ${tarea}`;

    // Construir el objeto JSON con todos los datos, incluyendo la fecha
    const data = {
        usuario: usuario,
        descripcion: descripcion,
        fecha: fecha
    };
    // JSON de envío al formulario
    const formData = {
        usuario: usuario,
        nombre: nombre,
        cargo: cargo,
        usuario_da: usuarioDa,
        activo_fijo: activoFijo,
        contrasena: contrasena,
        contacto: contacto,
        tarea: tarea,
        especificacion: especificacion,
        observaciones: observaciones,
        fecha: fecha,
    };
    // Luego, guardar en la base de datos
    $.ajax({
        url: 'http://localhost:8080/Proyectos/Ext%20PUMS/Beta%200.2/Casos%20creados/insertar.php',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(result) {
            if (result.success) {
                alert('Datos insertados correctamente.');
            } else {
                alert('Error al insertar datos: ' + result.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error en la solicitud AJAX:', error);
            alert('Hubo un error al enviar los datos.');
        }
    })
    .catch(error => console.error('Error:', error));
    console.log("Datos a enviar a la base de datos", formData);
    console.log("Datos a enviar a la api", data)
    // Enviar los datos al servidor de la API para creación del caso (con solo los campos necesarios)
    sendFormData({usuario: usuario, descripcion: descripcion, fecha: fecha });
});

// Función para enviar los datos del formulario
function sendFormData(data) {
    $.ajax({
        url: 'http://localhost:5134/api/Casos/crear-caso',  // Esta URL debe estar correcta
        type: 'POST',
        contentType: 'application/json', // Asegúrate de que el contenido sea JSON
        data: JSON.stringify(data),  // Convertir el objeto a JSON
        success: function(response) {
    console.log('Respuesta del servidor:', response);
    
    // Primero, parseamos la propiedad 'respuesta', que es una cadena JSON
    const respuesta = JSON.parse(response.respuesta);

    // Accedemos a los datos correctos dentro de 'DETALLE'
    const numero_caso = respuesta.DETALLE.numero_caso || '';
    const nombre_ingeniero = respuesta.DETALLE.nombre_ingeniero || '';

    // Mostrar alerta con la información
    alert(`Se ha creado el caso exitosamente. Caso ${numero_caso} con el ingeniero ${nombre_ingeniero}.`);
    $('#mantenimientoForm')[0].reset();
    $('#mantenimientoForm').find(':submit').prop('disabled', true); // Desactiva el botón de envío
},

        error: function(xhr, status, error) {
            console.error('Error al enviar datos:', error);
            alert('Hubo un error al enviar los datos. Por favor, intente nuevamente.');
        }
    });
}
 </script>
 



</body>
</html>