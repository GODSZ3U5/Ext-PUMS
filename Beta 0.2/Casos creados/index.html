<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Casos</title>
    <!-- Incluye Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container mt-5">
    <h1>Gestión de Casos</h1>

    <!-- Filtro de Búsqueda -->
    <form id="formBuscar" class="mb-3">
        <input type="text" id="buscarNombre" class="form-control" placeholder="Buscar por Nombre">
        <button type="submit" class="btn btn-primary mt-2">Buscar</button>
    </form>

    <!-- Tabla de Casos -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Cargo</th>
                <th>Usuario DA</th>
                <th>Activo Fijo</th>
                <th>Contrasena</th>
                <th>Contacto</th>
                <th>Tarea</th>
                <th>Especificación</th>
                <th>Observaciones</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla">
            <!-- Aquí se agregan las filas dinámicamente -->
        </tbody>
    </table>

    <!-- Botón para crear nuevo caso -->
    <button class="btn btn-success mb-3" data-toggle="modal" data-target="#crearModal">Crear Caso</button>
</div>

<!-- Modal para Crear -->
<div class="modal fade" id="crearModal" tabindex="-1" role="dialog" aria-labelledby="crearModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearModalLabel">Crear Caso</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCrear">
                    <div class="form-group">
                        <label for="nombreCrear">Nombre</label>
                        <input type="text" class="form-control" id="nombreCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="cargoCrear">Cargo</label>
                        <input type="text" class="form-control" id="cargoCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario_daCrear">Usuario DA</label>
                        <input type="text" class="form-control" id="usuario_daCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="activo_fijo_equipoCrear">Activo Fijo</label>
                        <input type="text" class="form-control" id="activo_fijo_equipoCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="contrasenaCrear">Contraseña</label>
                        <input type="text" class="form-control" id="contrasenaCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="contactoCrear">Contacto</label>
                        <input type="text" class="form-control" id="contactoCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="tareaCrear">Tarea</label>
                        <input type="text" class="form-control" id="tareaCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="especificacionCrear">Especificación</label>
                        <input type="text" class="form-control" id="especificacionCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="observacionesCrear">Observaciones</label>
                        <input type="text" class="form-control" id="observacionesCrear" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaCrear">Fecha</label>
                        <input type="date" class="form-control" id="fechaCrear" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar -->
<div class="modal fade" id="editarModal" tabindex="-1" role="dialog" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarModalLabel">Editar Caso</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEditar">
                    <input type="hidden" id="idEditar">
                    <div class="form-group">
                        <label for="nombreEditar">Nombre</label>
                        <input type="text" class="form-control" id="nombreEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="cargoEditar">Cargo</label>
                        <input type="text" class="form-control" id="cargoEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="usuario_daEditar">Usuario DA</label>
                        <input type="text" class="form-control" id="usuario_daEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="activo_fijo_equipoEditar">Activo Fijo</label>
                        <input type="text" class="form-control" id="activo_fijo_equipoEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="contrasenaEditar">Contrasena</label>
                        <input type="text" class="form-control" id="contrasenaEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="contactoEditar">Contacto</label>
                        <input type="text" class="form-control" id="contactoEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="tareaEditar">Tarea</label>
                        <input type="text" class="form-control" id="tareaEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="especificacionEditar">Especificación</label>
                        <input type="text" class="form-control" id="especificacionEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="observacionesEditar">Observaciones</label>
                        <input type="text" class="form-control" id="observacionesEditar" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaEditar">Fecha</label>
                        <input type="date" class="form-control" id="fechaEditar" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="eliminarModal" tabindex="-1" role="dialog" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eliminarModalLabel">Eliminar Caso</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ¿Está seguro de que desea eliminar este caso?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Incluye Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        // Cargar los datos en la tabla
        $.ajax({
            url: './CRUD casos/leer.php',
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                if (response.length > 0) {
                    response.forEach(function (caso) {
                        $('#cuerpoTabla').append(`
                            <tr id="caso-${caso.id}">
                                <td>${caso.nombre}</td>
                                <td>${caso.cargo}</td>
                                <td>${caso.usuario_da}</td>
                                <td>${caso.activo_fijo_equipo}</td>
                                <td>${caso.contrasena}</td>
                                <td>${caso.contacto}</td>
                                <td>${caso.tarea}</td>
                                <td>${caso.especificacion}</td>
                                <td>${caso.observaciones}</td>
                                <td>${caso.fecha}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm editar" data-id="${caso.id}">Editar</button>
                                    <button class="btn btn-danger btn-sm eliminar" data-id="${caso.id}">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                }
            }
        });
    
        // Abrir modal de crear
        $('#crearModal').on('show.bs.modal', function () {
            $('#formCrear')[0].reset();
        });
    
         // Enviar formulario de crear caso
         $('#formCrear').submit(function (e) {
    e.preventDefault();
    var formData = {
        nombre: $('#nombreCrear').val(),
        cargo: $('#cargoCrear').val(),
        usuario_da: $('#usuario_daCrear').val(),
        activo_fijo_equipo: $('#activo_fijo_equipoCrear').val(),
        contrasena: $('#contrasenaCrear').val(),
        contacto: $('#contactoCrear').val(),
        tarea: $('#tareaCrear').val(),
        especificacion: $('#especificacionCrear').val(),
        observaciones: $('#observacionesCrear').val(),
        fecha: $('#fechaCrear').val()
    };

    console.log("Datos enviados al servidor:", formData);

    $.ajax({
    url: './CRUD casos/crear.php',
    type: 'POST',
    data: formData,
    success: function (response) {
        console.log("Respuesta del servidor:", response);
        // No es necesario hacer JSON.parse() porque la respuesta es ya un objeto
        if (response.success) {
            alert('Caso creado con éxito.');
            $('#crearModal').modal('hide');
            cargarTabla();  // Función para recargar la tabla
        } else {
            alert('Error al crear el caso: ' + response.message);
        }
    },
    error: function (xhr, status, error) {
        console.error("Error en la solicitud AJAX:", error);
        alert('Hubo un error al realizar la solicitud. Intenta de nuevo más tarde.');
    }
});
         })
// Función para recargar la tabla
function cargarTabla() {
    $.ajax({
        url: './CRUD casos/leer.php',
        type: 'GET',
        dataType: 'json',
        success: function (response) {
            $('#cuerpoTabla').empty();  // Limpia la tabla antes de volver a cargar
            if (response.length > 0) {
                response.forEach(function (caso) {
                    $('#cuerpoTabla').append(`
                        <tr id="caso-${caso.id}">
                            <td>${caso.nombre}</td>
                            <td>${caso.cargo}</td>
                            <td>${caso.usuario_da}</td>
                            <td>${caso.activo_fijo_equipo}</td>
                            <td>${caso.contrasena}</td>
                            <td>${caso.contacto}</td>
                            <td>${caso.tarea}</td>
                            <td>${caso.especificacion}</td>
                            <td>${caso.observaciones}</td>
                            <td>${caso.fecha}</td>
                            <td>
                                <button class="btn btn-warning btn-sm editar" data-id="${caso.id}">Editar</button>
                                <button class="btn btn-danger btn-sm eliminar" data-id="${caso.id}">Eliminar</button>
                            </td>
                        </tr>
                    `);
                });
            }
        }
    });
}
    
$(document).on('click', '.eliminar', function () {
    var casoId = $(this).data('id');

    // Abre el modal de confirmación
    $('#eliminarModal').modal('show');

    // Eliminar manejadores previos antes de agregar uno nuevo
    $('#confirmarEliminar').off('click').on('click', function () {
        $.ajax({
            url: './CRUD casos/eliminar.php',
            type: 'POST',
            data: { id: casoId },
            dataType: 'json', // Especificar el tipo de datos esperado
            success: function (response) {
                if (response.success) {
                    // Eliminar fila de la tabla
                    $('#caso-' + casoId).remove();
                    alert('Caso eliminado con éxito'); // Mostrar alerta
                } else {
                    alert('Error al eliminar el caso: ' + response.error);
                }

                // Cerrar el modal
                $('#eliminarModal').modal('hide');
                cargarTabla();
            },
            error: function (xhr, status, error) {
                console.error('Error en la solicitud AJAX:', error);
                alert('Hubo un error al realizar la solicitud. Intenta de nuevo más tarde.');
            }
        });
    });
});
        // Filtrar por nombre
        $('#formBuscar').submit(function (e) {
                        e.preventDefault();
                        var nombre = $('#buscarNombre').val().toLowerCase();
                        $('#cuerpoTabla tr').each(function () {
                            var nombreFila = $(this).find('td').eq(0).text().toLowerCase();
                            if (nombreFila.indexOf(nombre) !== -1) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                    });
                });
// Evento cuando se hace clic en el botón de "Editar"
$(document).on('click', '.editar', function () {
    var casoId = $(this).data('id');  // Obtener el ID del caso seleccionado

    // Hacer una solicitud AJAX para obtener los datos del caso
    $.ajax({
        url: './CRUD casos/leercaso.php', // Usar leercaso.php para obtener los datos del caso
        type: 'GET',
        data: { id: casoId },  // Pasar el ID del caso a la API
        success: function (response) {
            if (response && !response.error) {
                // Llenar los campos del formulario con los datos del caso
                $('#idEditar').val(response.id);
                $('#nombreEditar').val(response.nombre);
                $('#cargoEditar').val(response.cargo);
                $('#usuario_daEditar').val(response.usuario_da);
                $('#activo_fijo_equipoEditar').val(response.activo_fijo_equipo);
                $('#contrasenaEditar').val(response.contrasena);
                $('#contactoEditar').val(response.contacto);
                $('#tareaEditar').val(response.tarea);
                $('#especificacionEditar').val(response.especificacion);
                $('#observacionesEditar').val(response.observaciones);
                $('#fechaEditar').val(response.fecha);  // Asegúrate de que la fecha sea compatible con el input de tipo date

                // Mostrar el modal con los datos precargados
                $('#editarModal').modal('show');
            } else {
                alert('No se encontraron los datos para este caso.');
            }
        },
        error: function (xhr, status, error) {
            console.error('Error al cargar los datos del caso:', error);
            alert('Hubo un error al cargar los datos del caso. Intenta de nuevo.');
        }
    });
});

//funcion para editar los datos
$('#formEditar').submit(function (e) {
    e.preventDefault();  // Prevenir el comportamiento por defecto del formulario

    // Obtener los valores de los campos del formulario
    var formData = {
        id: $('#idEditar').val(),  // ID del caso
        nombre: $('#nombreEditar').val(),
        cargo: $('#cargoEditar').val(),
        usuario_da: $('#usuario_daEditar').val(),
        activo_fijo_equipo: $('#activo_fijo_equipoEditar').val(),
        contrasena: $('#contrasenaEditar').val(),
        contacto: $('#contactoEditar').val(),
        tarea: $('#tareaEditar').val(),
        especificacion: $('#especificacionEditar').val(),
        observaciones: $('#observacionesEditar').val(),
        fecha: $('#fechaEditar').val()
    };

    // Enviar los datos al servidor para actualizar el caso
    $.ajax({
        url: './CRUD casos/actualizar.php',  // La URL que procesa la actualización en la base de datos
        type: 'POST',
        data: formData,
        success: function (response) {
            if (response.success) {
                alert('Caso actualizado con éxito.');
                $('#editarModal').modal('hide');
                cargarTabla();  // Recargar la tabla para reflejar los cambios
            } else {
                alert('Error al actualizar el caso: ' + response.error);
            }
        },
        error: function (xhr, status, error) {
            console.error('Error en la solicitud AJAX:', error);
            alert('Hubo un error al realizar la solicitud. Intenta de nuevo más tarde.');
        }
    });
});

</script>
</body>
</html>

